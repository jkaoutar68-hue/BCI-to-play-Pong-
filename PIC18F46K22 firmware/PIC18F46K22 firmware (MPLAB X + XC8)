#include <xc.h>
#include <stdint.h>
#include <stdio.h>

#define XTAL_FREQ  64000000UL

#pragma config FOSC = INTIO67  
#pragma config PLLCFG = ON     
#pragma config WDTEN = OFF
#pragma config PBADEN = OFF

// ADS1115 defines

#define ADS1115_ADDR  0x48      // SSend the ADDR pin to GND
#define ADS_REG_CONV  0x00
#define ADS_REG_CONF  0x01

void OSC_Init(void);
void I2C_Init(void);
void I2C_Wait(void);
void I2C_Start(void);
void I2C_Stop(void);
void I2C_Write(uint8_t data);
uint8_t I2C_Read(uint8_t ack);

void UART_Init(void);
void UART_SendChar(char c);
void UART_SendBytes(uint8_t *data, uint8_t len);

void ADS1115_Config(void);
int16_t ADS1115_Read(void);

void Timer2_Init(void);

volatile uint8_t sample_flag = 0;


void main(void)
{
    OSC_Init();
    I2C_Init();
    UART_Init();
    __delay_ms(50);

    ADS1115_Config();
    Timer2_Init();
    PEIE = 1;
    GIE = 1;

    while(1)
    {
        if (sample_flag)
        {
            sample_flag = 0;
            int16_t val = ADS1115_Read();

            uint8_t frame[4];
            frame[0] = 0x55;              // start byte
            frame[1] = (uint8_t)(val >> 8);
            frame[2] = (uint8_t)(val & 0xFF);
            frame[3] = '\n';
            UART_SendBytes(frame, 4);
        }
    }
}

void OSC_Init(void)
{
    OSCCON = 0b01110000;     
    OSCTUNEbits.PLLEN = 1;    
}

void I2C_Init(void)
{
    SSPCON1 = 0b00101000;  
    SSPCON2 = 0x00;
    SSPADD = (_XTAL_FREQ/(4*100000UL))-1;  
    SSPSTAT = 0;
    TRISC3 = 1; // SCL
    TRISC4 = 1; // SDA
}

void I2C_Wait(void){ while ((SSPCON2 & 0x1F) || (SSPSTAT & 0x04)); }
void I2C_Start(void){ I2C_Wait(); SEN = 1; }
void I2C_Stop(void){ I2C_Wait(); PEN = 1; }
void I2C_Write(uint8_t data){ I2C_Wait(); SSPBUF = data; }
uint8_t I2C_Read(uint8_t ack)
{
    uint8_t data;
    I2C_Wait(); RCEN = 1; I2C_Wait();
    data = SSPBUF; I2C_Wait();
    ACKDT = (ack)?0:1;
    ACKEN = 1;
    return data;
}

void UART_Init(void)
{
    TRISC6 = 0;  // TX
    TRISC7 = 1;  // RX

    // 57600 baud, BRGH=1
    TXSTAbits.BRGH = 1;
    SPBRG = (_XTAL_FREQ/(16UL*57600))-1; // ≈68
    TXSTAbits.SYNC = 0; // async
    RCSTAbits.SPEN = 1; // enable serial
    TXSTAbits.TXEN = 1;
    RCSTAbits.CREN = 1;
}

void UART_SendChar(char c)
{ while(!TXIF); TXREG = c; }

void UART_SendBytes(uint8_t *data, uint8_t len)
{
    for (uint8_t i=0; i<len; i++)
        UART_SendChar(data[i]);
}

void ADS1115_Config(void)
{
    // goal: Diff AIN0-AIN1, PGA=±2.048V, continuous, 475 SPS
    // Config word = 0x04C3  (MSB 0x04, LSB 0xC3)

    I2C_Start();
    I2C_Write(ADS1115_ADDR<<1);  // write
    I2C_Write(ADS_REG_CONF);
    I2C_Write(0x04);             // MSB
    I2C_Write(0xC3);             // LSB
    I2C_Stop();
}

int16_t ADS1115_Read(void)
{
    // set pointer to conversion reg
    I2C_Start();
    I2C_Write(ADS1115_ADDR<<1);      // write
    I2C_Write(ADS_REG_CONV);
    I2C_Start();
    I2C_Write((ADS1115_ADDR<<1)|1);  // read
    uint8_t hi = I2C_Read(1);
    uint8_t lo = I2C_Read(0);
    I2C_Stop();
    return (int16_t)((hi<<8)|lo);
}

// -------- Timer2 ISR -----------
void Timer2_Init(void)
{
    // goal: ~500 Hz
    // Fosc = 64 MHz -> Fcyc = 16 MHz (PIC18 = Fosc/4)
    // Timer2 freq = Fcyc / (4 * (PR2+1) * prescale)
    // let's go with prescale=16, PR2=49:
    // 16MHz / (4*50*16) = 16e6 / 3200 = 5000 Hz -> too fast
    // let's use PR2=249: 16e6 / (4*250*16) = 16e6 / 16000 = 1000 Hz
    //  sample every other ISR in code if needed
    T2CON = 0b00000111;  // prescale 16, timer2 on
    PR2 = 249;
    TMR2IE = 1;
}

void __interrupt() isr(void)
{
    static uint8_t div = 0;
    if (TMR2IF)
    {
        TMR2IF = 0;
        div++;
        if (div >= 2)   // 1000 Hz / 2 = 500 Hz effective
        {
            div = 0;
            sample_flag = 1;
        }
    }
}
